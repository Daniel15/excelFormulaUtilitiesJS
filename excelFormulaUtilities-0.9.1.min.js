/*
* excelFormulaUtilitiesJS #{VERSION}
* https://github.com/joshatjben/excelFormulaUtilitiesJS/
*
* Copyright #{YEAR}, Josh Bennett
* licensed under the MIT license.
* https://github.com/joshatjben/excelFormulaUtilitiesJS/blob/master/LICENSE.txt
*
* Some functionality based off of the jQuery(1.6.2) core lib
* Copyright 2011, John Resig
* Dual licensed under the MIT or GPL Version 2 licenses.
* http://jquery.org/license
*
* Based on Ewbi's Go Calc Prototype Excel Formula Parser. [http://ewbi.blogs.com/develops/2004/12/excel_formula_p.html]
*/

(function(){window.excelFormulaUtilities=window.excelFormulaUtilities||{};var n=window.excelFormulaUtilities.core={};window.excelFormulaUtilities.string=window.excelFormulaUtilities.string||{};window.excelFormulaUtilities.string.formatStr=function(k){for(var h=k,m=1;m<arguments.length;m++)h=h.replace(RegExp("\\{{1}"+(m-1).toString()+"{1}\\}{1}","g"),arguments[m]);return h};window.excelFormulaUtilities.string.trim=function(k){return k.replace(/^\s|\s$/,"")};window.excelFormulaUtilities.string.trim=
function(k){return k.replace(/^(?:\s|&nbsp;|<\s*br\s*\/*\s*>)*|(?:\s|&nbsp;|<\s*br\s*\/*\s*>)*$/,"")};var v=n.isFunction=function(k){return typeof k==="function"},w=n.isArray=function(k){return typeof k==="object"&&k.length},x=n.isWindow=function(){return obj&&typeof obj==="object"&&"setInterval"in obj},o=n.isPlainObject=function(k){if(!k||typeof k!=="object"||k.nodeType||x(k))return!1;if(k.constructor&&!hasOwnProperty.call(k,"constructor")&&!hasOwnProperty.call(k.constructor.prototype,"isPrototypeOf"))return!1;
for(var h in k);return h===void 0||hasOwnProperty.call(k,h)};n.extend=function(){var k,h,m,d,s,i=arguments[0]||{},l=1,r=arguments.length,t=!1;typeof i==="boolean"&&(t=i,i=arguments[1]||{},l=2);typeof i!=="object"&&!v(i)&&(i={});r===l&&(i=this,--l);for(;l<r;l++)if((k=arguments[l])!=null)for(h in k)m=i[h],d=k[h],i!==d&&(t&&d&&(o(d)||(s=w(d)))?(s?(s=!1,m=m&&w(m)?m:[]):m=m&&o(m)?m:{},i[h]=n.extend(t,m,d)):d!==void 0&&(i[h]=d));return i}})();
(function(){function n(j,b,c){this.value=j;this.type=b;this.subtype=c}function v(){this.items=[];this.add=function(j,b,c){c||(c="");j=new n(j,b,c);this.addRef(j);return j};this.addRef=function(j){this.items.push(j)};this.index=-1;this.reset=function(){this.index=-1};this.BOF=function(){return this.index<=0};this.EOF=function(){return this.index>=this.items.length-1};this.moveNext=function(){if(this.EOF())return!1;this.index+=1;return!0};this.current=function(){return this.index===-1?null:this.items[this.index]};
this.next=function(){return this.EOF()?null:this.items[this.index+1]};this.previous=function(){return this.index<1?null:this.items[this.index-1]}}function w(){this.items=[];this.push=function(j){this.items.push(j)};this.pop=function(j){var b=this.items.pop();return new n(j||"",b.type,p)};this.token=function(){return this.items.length>0?this.items[this.items.length-1]:null};this.value=function(){return this.token()?this.token().value.toString():""};this.type=function(){return this.token()?this.token().type.toString():
""};this.subtype=function(){return this.token()?this.token().subtype.toString():""}}function x(j){for(var b=new v,c=new w,g=0,f=function(){return j.substr(g,1)},a="",e=!1,d=!1,k=!1,h=!1,m=/^[1-9]{1}(\.[0-9]+)?E{1}$/;j.length>0;)if(j.substr(0,1)===" ")j=j.substr(1);else{j.substr(0,1)==="="&&(j=j.substr(1));break}for(;!(g>=j.length);)if(e)f()==='"'?j.substr(g+1,1)==='"'?(a+='"',g+=1):(e=!1,b.add(a,i,F),a=""):a+=f(),g+=1;else if(d)f()==="'"?j.substr(g+1,1)==="'"?(a+="'",g+=1):d=!1:a+=f(),g+=1;else if(k)f()===
"]"&&(k=!1),a+=f(),g+=1;else if(h)a+=f(),g+=1,",#NULL!,#DIV/0!,#VALUE!,#REF!,#NAME?,#NUM!,#N/A,".indexOf(","+a+",")!==-1&&(h=!1,b.add(a,i,G),a="");else if("+-".indexOf(f())!==-1&&a.length>1&&a.match(m))a+=f(),g+=1;else if(f()==='"')a.length>0&&(b.add(a,y),a=""),e=!0,g+=1;else if(f()==="'")a.length>0&&(b.add(a,y),a=""),d=!0,g+=1;else if(f()==="[")k=!0,a+=f(),g+=1;else if(f()==="#")a.length>0&&(b.add(a,y),a=""),h=!0,a+=f(),g+=1;else if(f()==="{")a.length>0&&(b.add(a,y),a=""),c.push(b.add("ARRAY",l,
q)),c.push(b.add("ARRAYROW",l,q)),g+=1;else if(f()===";")a.length>0&&(b.add(a,i),a=""),b.addRef(c.pop()),b.add(",",t),c.push(b.add("ARRAYROW",l,q)),g+=1;else if(f()==="}")a.length>0&&(b.add(a,i),a=""),b.addRef(c.pop("ARRAYROWSTOP")),b.addRef(c.pop("ARRAYSTOP")),g+=1;else if(f()===" "){a.length>0&&(b.add(a,i),a="");b.add("",C);for(g+=1;f()===" "&&!(g>=j.length);)g+=1}else",>=,<=,<>,".indexOf(","+j.substr(g,2)+",")!==-1?(a.length>0&&(b.add(a,i),a=""),b.add(j.substr(g,2),u,z),g+=2):("+-*/^&=><".indexOf(f())!==
-1?(a.length>0&&(b.add(a,i),a=""),b.add(f(),u)):"%".indexOf(f())!==-1?(a.length>0&&(b.add(a,i),a=""),b.add(f(),A)):f()==="("?a.length>0?(c.push(b.add(a,l,q)),a=""):c.push(b.add("",r,q)):f()===","?(a.length>0&&(b.add(a,i),a=""),c.type()!==l?b.add(f(),u,H):b.add(f(),t)):f()===")"?(a.length>0&&(b.add(a,i),a=""),b.addRef(c.pop())):a+=f(),g+=1);a.length>0&&b.add(a,i);for(c=new v;b.moveNext();)a=b.current(),a.type.toString()===C?(f=(f=(f=b.BOF()||b.EOF())&&(b.previous().type.toString()===l&&b.previous().subtype.toString()===
p||b.previous().type.toString()===r&&b.previous().subtype.toString()===p||b.previous().type.toString()===i))&&(b.next().type.toString()===l&&b.next().subtype.toString()===q||b.next().type.toString()===r&&b.next().subtype.toString()===q||b.next().type.toString()===i))&&c.add(a.value.toString(),u,I):c.addRef(a);for(;c.moveNext();)if(a=c.current(),a.type.toString()===u&&a.value.toString()==="-")c.BOF()?a.type=D.toString():c.previous().type.toString()===l&&c.previous().subtype.toString()===p||c.previous().type.toString()===
r&&c.previous().subtype.toString()===p||c.previous().type.toString()===A||c.previous().type.toString()===i?a.subtype=B.toString():a.type=D.toString();else if(a.type.toString()===u&&a.value.toString()==="+")c.BOF()?a.type=s.toString():c.previous().type.toString()===l&&c.previous().subtype.toString()===p||c.previous().type.toString()===r&&c.previous().subtype.toString()===p||c.previous().type.toString()===A||c.previous().type.toString()===i?a.subtype=B.toString():a.type=s.toString();else if(a.type.toString()===
u&&a.subtype.length===0)a.subtype="<>=".indexOf(a.value.substr(0,1))!==-1?z.toString():a.value.toString()==="&"?J.toString():B.toString();else if(a.type.toString()===i&&a.subtype.length===0)a.subtype=isNaN(parseFloat(a.value))?a.value.toString()==="TRUE"||a.value.toString()==="FALSE"?z.toString():K.toString():L.toString();else if(a.type.toString()===l&&a.value.substr(0,1)==="@")a.value=a.value.substr(1).toString();c.reset();for(b=new v;c.moveNext();)c.current().type.toString()!==s&&b.addRef(c.current());
b.reset();return b}var o=window.excelFormulaUtilities=window.excelFormulaUtilities||{},k=window.excelFormulaUtilities.core,h=window.excelFormulaUtilities.string.formatStr,m=window.excelFormulaUtilities.string.trim,d={},s=d.TOK_TYPE_NOOP="noop",i=d.TOK_TYPE_OPERAND="operand",l=d.TOK_TYPE_FUNCTION="function",r=d.TOK_TYPE_SUBEXPR="subexpression",t=d.TOK_TYPE_ARGUMENT="argument",D=d.TOK_TYPE_OP_PRE="operator-prefix",u=d.TOK_TYPE_OP_IN="operator-infix",A=d.TOK_TYPE_OP_POST="operator-postfix",C=d.TOK_TYPE_WSPACE=
"white-space",y=d.TOK_TYPE_UNKNOWN="unknown",q=d.TOK_SUBTYPE_START="start",p=d.TOK_SUBTYPE_STOP="stop",F=d.TOK_SUBTYPE_TEXT="text",L=d.TOK_SUBTYPE_NUMBER="number",z=d.TOK_SUBTYPE_LOGICAL="logical",G=d.TOK_SUBTYPE_ERROR="error",K=d.TOK_SUBTYPE_RANGE="range",B=d.TOK_SUBTYPE_MATH="math",J=d.TOK_SUBTYPE_CONCAT="concatenate",I=d.TOK_SUBTYPE_INTERSECT="intersect",H=d.TOK_SUBTYPE_UNION="union";o.parseFormula=function(j,b){var c=0,g=function(){for(var a="|",b=0;b<c;b+=1)a+="&nbsp;&nbsp;&nbsp;|";return a},
f=document.getElementById(j),a=x(f.value),e="";e+="<table cellspacing='0' style='border-top: 1px #cecece solid; margin-top: 5px; margin-bottom: 5px'>";e+="<tr>";e+="<td class='token' style='font-weight: bold; width: 50px'>index</td>";e+="<td class='token' style='font-weight: bold; width: 125px'>type</td>";e+="<td class='token' style='font-weight: bold; width: 125px'>subtype</td>";e+="<td class='token' style='font-weight: bold; width: 150px'>token</td>";for(e+="<td class='token' style='font-weight: bold; width: 300px'>token tree</td></tr>";a.moveNext();){var d=
a.current();d.subtype===p&&(c-=c>0?1:0);e+="<tr>";e+="<td class='token'>"+(a.index+1)+"</td>";e+="<td class='token'>"+d.type+"</td>";e+="<td class='token'>"+(d.subtype.length===0?"&nbsp;":d.subtype.toString())+"</td>";e+="<td class='token'>"+(d.value.length===0?"&nbsp;":d.value).split(" ").join("&nbsp;")+"</td>";e+="<td class='token'>"+g()+(d.value.length===0?"&nbsp;":d.value).split(" ").join("&nbsp;")+"</td>";e+="</tr>";d.subtype===q&&(c+=1)}e+="</table>";document.getElementById(b).innerHTML=e;f.select();
f.focus()};var M=function(d,b,c,g,f){var a=function(a){return a.replace(/\{\{token\}\}/gi,"{0}").replace(/\{\{autoindent\}\}/gi,"{1}").replace(/\{\{autolinebreak\}\}/gi,"{2}")},e=(d.value.length===0?" ":d.value.toString()).split(" ").join("").toString();if(typeof f==="function"&&(f=f(e,d,c,g),e=f.tokenString,!f.useTemplate))return e;switch(d.type){case "function":switch(d.value){case "ARRAY":e=h(a(b.tmplFunctionStartArray),e,c,g);break;case "ARRAYROW":e=h(a(b.tmplFunctionStartArrayRow),e,c,g);break;
default:e=d.subtype.toString()==="start"?h(a(b.tmplFunctionStart),e,c,g):h(a(b.tmplFunctionStop),e,c,g)}break;case "operand":switch(d.subtype.toString()){case "error":e=h(a(b.tmplOperandError),e,c,g);break;case "range":e=h(a(b.tmplOperandRange),e,c,g);break;case "number":e=h(a(b.tmplOperandNumber),e,c,g);break;case "text":e=h(a(b.tmplOperandText),e,c,g);break;case "argument":e=h(a(b.tmplArgument),e,c,g)}break;case "operator-infix":case "logical":e=h(a(b.tmplOperandLogical),e,c,g);break;case "argument":e=
h(a(b.tmplArgument),e,c,g);break;case "subexpression":e=d.subtype.toString()==="start"?h(a(b.tmplSubexpressionStart),e,c,g):h(a(b.tmplSubexpressionStop),e,c,g)}return e},E=o.formatFormula=function(j,b){for(var c={tmplFunctionStart:"{{autoindent}}{{token}}\n{{autoindent}}(\n",tmplFunctionStop:"\n{{autoindent}}{{token}})",tmplOperandError:"{{token}}",tmplOperandRange:"{{autoindent}}{{token}}",tmplOperandLogical:"{{token}}{{autolinebreak}}",tmplOperandNumber:"{{autoindent}}{{token}}",tmplOperandText:'{{autoindent}}"{{token}}"',
tmplArgument:"{{token}}\n",tmplFunctionStartArray:"",tmplFunctionStartArrayRow:"{",tmplFunctionStopArrayRow:"}",tmplFunctionStopArray:"",tmplSubexpressionStart:"{{autoindent}}(",tmplSubexpressionStop:" )",tmplIndentTab:"\t",tmplIndentSpace:" ",autoLineBreak:"TOK_TYPE_FUNCTION | TOK_TYPE_ARGUMENT | TOK_SUBTYPE_LOGICAL | TOK_TYPE_OP_IN ",newLine:"\n",trim:!0,customTokenRender:null},b=b?k.extend(!0,c,b):c,g=0,c=function(){for(var a="",c=0;c<g;c+=1)a+=b.tmplIndentTab;return a},f=x(j),a="",e=b.autoLineBreak.replace(/\s/gi,
"").split("|"),h=!0,i=function(a){for(var b=0;b<e.length;b+=1)if(a!==null&&typeof a!=="undefined"&&(d[e[b]]===a.type.toString()||d[e[b]]===a.subtype.toString()))return!0;return!1};f.moveNext();){var l=f.current(),n=f.next();l.subtype.toString()===p&&(g-=g>0?1:0);var o=RegExp(b.newLine+"$",""),n=i(n),h=h?c():b.tmplIndentSpace;a+=M(l,b,h,n?b.newLine:"",b.customTokenRender);l.subtype.toString()===q&&(g+=1);h=n||o.test(a)}return b.trim?m(a):a};o.formatFormulaHTML=function(d){return E(d,{tmplFunctionStart:'{{autoindent}}<span class="function">{{token}}</span><br />{{autoindent}}<span class="function_start">(</span><br />',
tmplFunctionStop:'<br />{{autoindent}}{{token}}<span class="function_stop">)</span>',tmplOperandError:"{{token}}",tmplOperandRange:"{{autoindent}}{{token}}",tmplOperandLogical:" {{token}}{{autolinebreak}}",tmplOperandNumber:"{{autoindent}}{{token}}",tmplOperandText:'{{autoindent}}<span class="quote_mark">"</span><span class="text">{{token}}</span><span class="quote_mark">"</span>',tmplArgument:"{{token}}<br />",tmplFunctionStartArray:"",tmplFunctionStartArrayRow:"{",tmplFunctionStopArrayRow:"}",tmplFunctionStopArray:"",
tmplSubexpressionStart:"{{autoindent}}(",tmplSubexpressionStop:" )",tmplIndentTab:'<span class="tabs">&nbsp;&nbsp;&nbsp;&nbsp;</span>',tmplIndentSpace:"&nbsp;",newLine:"<br />",autoLineBreak:"TOK_TYPE_FUNCTION | TOK_TYPE_ARGUMENT | TOK_SUBTYPE_LOGICAL | TOK_TYPE_OP_IN ",trim:!0,customTokenRender:null})};var N=o.formula2CSharp=function(d){var b=[];return E(d,{tmplFunctionStart:"{{token}}(",tmplFunctionStop:"{{token}})",tmplOperandError:"{{token}}",tmplOperandRange:"{{token}}",tmplOperandLogical:"{{token}}",
tmplOperandNumber:"{{token}}",tmplOperandText:'"{{token}}"',tmplArgument:"{{token}}",tmplFunctionStartArray:"",tmplFunctionStartArrayRow:"{",tmplFunctionStopArrayRow:"}",tmplFunctionStopArray:"",tmplSubexpressionStart:"(",tmplSubexpressionStop:")",tmplIndentTab:"\t",tmplIndentSpace:" ",autoLineBreak:"TOK_SUBTYPE_STOP | TOK_SUBTYPE_START | TOK_TYPE_ARGUMENT",trim:!0,customTokenRender:function(c,d){var f="",a={"=":"==","<>":"!=",MIN:"Math.Min",MAX:"Math.Max",ABS:"Math.ABS",SUM:"",IF:"","&":"+"},e=b[b.length-
1],h=!1;switch(d.type.toString()){case l:switch(d.subtype){case q:b.push({name:c,argumentNumber:0});f=typeof a[c]==="string"?a[c]:c;h=!0;break;case p:h=!0;switch(e.name.toLowerCase()){case "if":f=")";h=!1;break;default:f=typeof a[c]==="string"?a[c]:c}b.pop()}break;case t:switch(e.name.toLowerCase()){case "if":switch(e.argumentNumber){case 0:f="?";break;case 1:f=":"}break;case "sum":f="+";break;default:f=typeof a[c]==="string"?a[c]:c,h=!0}e.argumentNumber+=1;break;default:f=typeof a[c]==="string"?
a[c]:c,h=!0}return{tokenString:f,useTemplate:h}}})};o.formula2JavaScript=function(d){return N(d)}})();
