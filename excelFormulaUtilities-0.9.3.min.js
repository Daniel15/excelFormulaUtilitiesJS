/*
* excelFormulaUtilitiesJS 0.9.3
* https://github.com/joshatjben/excelFormulaUtilitiesJS/
*
* Copyright 2011, Josh Bennett
* licensed under the MIT license.
* https://github.com/joshatjben/excelFormulaUtilitiesJS/blob/master/LICENSE.txt
*
* Some functionality based off of the jQuery(1.6.2) core lib
* Copyright 2011, John Resig
* Dual licensed under the MIT or GPL Version 2 licenses.
* http://jquery.org/license
*
* Based on Ewbi's Go Calc Prototype Excel Formula Parser. [http://ewbi.blogs.com/develops/2004/12/excel_formula_p.html]
*/
(function(){window.excelFormulaUtilities=window.excelFormulaUtilities||{};var n=window.excelFormulaUtilities.core={};window.excelFormulaUtilities.string=window.excelFormulaUtilities.string||{};window.excelFormulaUtilities.string.formatStr=function(k){for(var i=k,m=1;m<arguments.length;m++)i=i.replace(RegExp("\\{{1}"+(m-1).toString()+"{1}\\}{1}","g"),arguments[m]);return i};window.excelFormulaUtilities.string.trim=function(k){return k.replace(/^\s|\s$/,"")};window.excelFormulaUtilities.string.trim=
function(k){return k.replace(/^(?:\s|&nbsp;|<\s*br\s*\/*\s*>)*|(?:\s|&nbsp;|<\s*br\s*\/*\s*>)*$/,"")};var v=n.isFunction=function(k){return typeof k==="function"},w=n.isArray=function(k){return typeof k==="object"&&k.length},x=n.isWindow=function(){return obj&&typeof obj==="object"&&"setInterval"in obj},o=n.isPlainObject=function(k){if(!k||typeof k!=="object"||k.nodeType||x(k))return!1;if(k.constructor&&!hasOwnProperty.call(k,"constructor")&&!hasOwnProperty.call(k.constructor.prototype,"isPrototypeOf"))return!1;
for(var i in k);return i===void 0||hasOwnProperty.call(k,i)};n.extend=function(){var k,i,m,h,s,j=arguments[0]||{},l=1,r=arguments.length,t=!1;typeof j==="boolean"&&(t=j,j=arguments[1]||{},l=2);typeof j!=="object"&&!v(j)&&(j={});r===l&&(j=this,--l);for(;l<r;l++)if((k=arguments[l])!=null)for(i in k)m=j[i],h=k[i],j!==h&&(t&&h&&(o(h)||(s=w(h)))?(s?(s=!1,m=m&&w(m)?m:[]):m=m&&o(m)?m:{},j[i]=n.extend(t,m,h)):h!==void 0&&(j[i]=h));return j}})();
(function(){function n(f,b,c){this.value=f;this.type=b;this.subtype=c}function v(){this.items=[];this.add=function(f,b,c){c||(c="");f=new n(f,b,c);this.addRef(f);return f};this.addRef=function(f){this.items.push(f)};this.index=-1;this.reset=function(){this.index=-1};this.BOF=function(){return this.index<=0};this.EOF=function(){return this.index>=this.items.length-1};this.moveNext=function(){if(this.EOF())return!1;this.index+=1;return!0};this.current=function(){return this.index===-1?null:this.items[this.index]};
this.next=function(){return this.EOF()?null:this.items[this.index+1]};this.previous=function(){return this.index<1?null:this.items[this.index-1]}}function w(){this.items=[];this.push=function(f){this.items.push(f)};this.pop=function(f){var b=this.items.pop();return new n(f||"",b.type,p)};this.token=function(){return this.items.length>0?this.items[this.items.length-1]:null};this.value=function(){return this.token()?this.token().value.toString():""};this.type=function(){return this.token()?this.token().type.toString():
""};this.subtype=function(){return this.token()?this.token().subtype.toString():""}}function x(f){for(var b=new v,c=new w,g=0,e=function(){return f.substr(g,1)},a="",d=!1,h=!1,k=!1,i=!1,m=/^[1-9]{1}(\.[0-9]+)?E{1}$/;f.length>0;)if(f.substr(0,1)===" ")f=f.substr(1);else{f.substr(0,1)==="="&&(f=f.substr(1));break}for(;!(g>=f.length);)if(d)e()==='"'?f.substr(g+1,1)==='"'?(a+='"',g+=1):(d=!1,b.add(a,j,F),a=""):a+=e(),g+=1;else if(h)e()==="'"?f.substr(g+1,1)==="'"?(a+="'",g+=1):h=!1:a+=e(),g+=1;else if(k)e()===
"]"&&(k=!1),a+=e(),g+=1;else if(i)a+=e(),g+=1,",#NULL!,#DIV/0!,#VALUE!,#REF!,#NAME?,#NUM!,#N/A,".indexOf(","+a+",")!==-1&&(i=!1,b.add(a,j,G),a="");else if("+-".indexOf(e())!==-1&&a.length>1&&a.match(m))a+=e(),g+=1;else if(e()==='"')a.length>0&&(b.add(a,y),a=""),d=!0,g+=1;else if(e()==="'")a.length>0&&(b.add(a,y),a=""),h=!0,g+=1;else if(e()==="[")k=!0,a+=e(),g+=1;else if(e()==="#")a.length>0&&(b.add(a,y),a=""),i=!0,a+=e(),g+=1;else if(e()==="{")a.length>0&&(b.add(a,y),a=""),c.push(b.add("ARRAY",l,
q)),c.push(b.add("ARRAYROW",l,q)),g+=1;else if(e()===";")a.length>0&&(b.add(a,j),a=""),b.addRef(c.pop()),b.add(",",t),c.push(b.add("ARRAYROW",l,q)),g+=1;else if(e()==="}")a.length>0&&(b.add(a,j),a=""),b.addRef(c.pop("ARRAYROWSTOP")),b.addRef(c.pop("ARRAYSTOP")),g+=1;else if(e()===" "){a.length>0&&(b.add(a,j),a="");b.add("",C);for(g+=1;e()===" "&&!(g>=f.length);)g+=1}else",>=,<=,<>,".indexOf(","+f.substr(g,2)+",")!==-1?(a.length>0&&(b.add(a,j),a=""),b.add(f.substr(g,2),u,z),g+=2):("+-*/^&=><".indexOf(e())!==
-1?(a.length>0&&(b.add(a,j),a=""),b.add(e(),u)):"%".indexOf(e())!==-1?(a.length>0&&(b.add(a,j),a=""),b.add(e(),A)):e()==="("?a.length>0?(c.push(b.add(a,l,q)),a=""):c.push(b.add("",r,q)):e()===","?(a.length>0&&(b.add(a,j),a=""),c.type()!==l?b.add(e(),u,H):b.add(e(),t)):e()===")"?(a.length>0&&(b.add(a,j),a=""),b.addRef(c.pop())):a+=e(),g+=1);a.length>0&&b.add(a,j);for(c=new v;b.moveNext();)a=b.current(),a.type.toString()===C?(e=(e=(e=b.BOF()||b.EOF())&&(b.previous().type.toString()===l&&b.previous().subtype.toString()===
p||b.previous().type.toString()===r&&b.previous().subtype.toString()===p||b.previous().type.toString()===j))&&(b.next().type.toString()===l&&b.next().subtype.toString()===q||b.next().type.toString()===r&&b.next().subtype.toString()===q||b.next().type.toString()===j))&&c.add(a.value.toString(),u,I):c.addRef(a);for(;c.moveNext();)if(a=c.current(),a.type.toString()===u&&a.value.toString()==="-")c.BOF()?a.type=D.toString():c.previous().type.toString()===l&&c.previous().subtype.toString()===p||c.previous().type.toString()===
r&&c.previous().subtype.toString()===p||c.previous().type.toString()===A||c.previous().type.toString()===j?a.subtype=B.toString():a.type=D.toString();else if(a.type.toString()===u&&a.value.toString()==="+")c.BOF()?a.type=s.toString():c.previous().type.toString()===l&&c.previous().subtype.toString()===p||c.previous().type.toString()===r&&c.previous().subtype.toString()===p||c.previous().type.toString()===A||c.previous().type.toString()===j?a.subtype=B.toString():a.type=s.toString();else if(a.type.toString()===
u&&a.subtype.length===0)a.subtype="<>=".indexOf(a.value.substr(0,1))!==-1?z.toString():a.value.toString()==="&"?J.toString():B.toString();else if(a.type.toString()===j&&a.subtype.length===0)a.subtype=isNaN(parseFloat(a.value))?a.value.toString()==="TRUE"||a.value.toString()==="FALSE"?z.toString():K.toString():L.toString();else if(a.type.toString()===l&&a.value.substr(0,1)==="@")a.value=a.value.substr(1).toString();c.reset();for(b=new v;c.moveNext();)c.current().type.toString()!==s&&b.addRef(c.current());
b.reset();return b}var o=window.excelFormulaUtilities=window.excelFormulaUtilities||{},k=window.excelFormulaUtilities.core,i=window.excelFormulaUtilities.string.formatStr,m=window.excelFormulaUtilities.string.trim,h={},s=h.TOK_TYPE_NOOP="noop",j=h.TOK_TYPE_OPERAND="operand",l=h.TOK_TYPE_FUNCTION="function",r=h.TOK_TYPE_SUBEXPR="subexpression",t=h.TOK_TYPE_ARGUMENT="argument",D=h.TOK_TYPE_OP_PRE="operator-prefix",u=h.TOK_TYPE_OP_IN="operator-infix",A=h.TOK_TYPE_OP_POST="operator-postfix",C=h.TOK_TYPE_WSPACE=
"white-space",y=h.TOK_TYPE_UNKNOWN="unknown",q=h.TOK_SUBTYPE_START="start",p=h.TOK_SUBTYPE_STOP="stop",F=h.TOK_SUBTYPE_TEXT="text",L=h.TOK_SUBTYPE_NUMBER="number",z=h.TOK_SUBTYPE_LOGICAL="logical",G=h.TOK_SUBTYPE_ERROR="error",K=h.TOK_SUBTYPE_RANGE="range",B=h.TOK_SUBTYPE_MATH="math",J=h.TOK_SUBTYPE_CONCAT="concatenate",I=h.TOK_SUBTYPE_INTERSECT="intersect",H=h.TOK_SUBTYPE_UNION="union";o.parseFormula=function(f,b){var c=0,g=function(){for(var a="|",b=0;b<c;b+=1)a+="&nbsp;&nbsp;&nbsp;|";return a},
e=document.getElementById(f),a=x(e.value),d="";d+="<table cellspacing='0' style='border-top: 1px #cecece solid; margin-top: 5px; margin-bottom: 5px'>";d+="<tr>";d+="<td class='token' style='font-weight: bold; width: 50px'>index</td>";d+="<td class='token' style='font-weight: bold; width: 125px'>type</td>";d+="<td class='token' style='font-weight: bold; width: 125px'>subtype</td>";d+="<td class='token' style='font-weight: bold; width: 150px'>token</td>";for(d+="<td class='token' style='font-weight: bold; width: 300px'>token tree</td></tr>";a.moveNext();){var h=
a.current();h.subtype===p&&(c-=c>0?1:0);d+="<tr>";d+="<td class='token'>"+(a.index+1)+"</td>";d+="<td class='token'>"+h.type+"</td>";d+="<td class='token'>"+(h.subtype.length===0?"&nbsp;":h.subtype.toString())+"</td>";d+="<td class='token'>"+(h.value.length===0?"&nbsp;":h.value).split(" ").join("&nbsp;")+"</td>";d+="<td class='token'>"+g()+(h.value.length===0?"&nbsp;":h.value).split(" ").join("&nbsp;")+"</td>";d+="</tr>";h.subtype===q&&(c+=1)}d+="</table>";document.getElementById(b).innerHTML=d;e.select();
e.focus()};var M=function(f,b,c,g,e){var a=function(a){return a.replace(/\{\{token\}\}/gi,"{0}").replace(/\{\{autoindent\}\}/gi,"{1}").replace(/\{\{autolinebreak\}\}/gi,"{2}")},d="",d=f.subtype==="text"||f.type==="text"?f.value.toString():(f.value.length===0?" ":f.value.toString()).split(" ").join("").toString();if(typeof e==="function"&&(e=e(d,f,c,g),d=e.tokenString,!e.useTemplate))return d;switch(f.type){case "function":switch(f.value){case "ARRAY":d=i(a(b.tmplFunctionStartArray),d,c,g);break;case "ARRAYROW":d=
i(a(b.tmplFunctionStartArrayRow),d,c,g);break;default:d=f.subtype.toString()==="start"?i(a(b.tmplFunctionStart),d,c,g):i(a(b.tmplFunctionStop),d,c,g)}break;case "operand":switch(f.subtype.toString()){case "error":d=i(a(b.tmplOperandError),d,c,g);break;case "range":d=i(a(b.tmplOperandRange),d,c,g);break;case "number":d=i(a(b.tmplOperandNumber),d,c,g);break;case "text":d=i(a(b.tmplOperandText),d,c,g);break;case "argument":d=i(a(b.tmplArgument),d,c,g)}break;case "operator-infix":case "logical":d=i(a(b.tmplOperandLogical),
d,c,g);break;case "argument":d=i(a(b.tmplArgument),d,c,g);break;case "subexpression":d=f.subtype.toString()==="start"?i(a(b.tmplSubexpressionStart),d,c,g):i(a(b.tmplSubexpressionStop),d,c,g)}return d},E=o.formatFormula=function(f,b){for(var c={tmplFunctionStart:"{{autoindent}}{{token}}\n{{autoindent}}(\n",tmplFunctionStop:"\n{{autoindent}}{{token}})",tmplOperandError:"{{token}}",tmplOperandRange:"{{autoindent}}{{token}}",tmplOperandLogical:" {{token}}{{autolinebreak}}",tmplOperandNumber:"{{autoindent}}{{token}}",
tmplOperandText:'{{autoindent}}"{{token}}"',tmplArgument:"{{token}}\n",tmplFunctionStartArray:"",tmplFunctionStartArrayRow:"{",tmplFunctionStopArrayRow:"}",tmplFunctionStopArray:"",tmplSubexpressionStart:"{{autoindent}}(",tmplSubexpressionStop:" )",tmplIndentTab:"\t",tmplIndentSpace:" ",autoLineBreak:"TOK_TYPE_FUNCTION | TOK_TYPE_ARGUMENT | TOK_SUBTYPE_LOGICAL | TOK_TYPE_OP_IN ",newLine:"\n",trim:!0,customTokenRender:null},b=b?k.extend(!0,c,b):c,g=0,c=function(){for(var a="",c=0;c<g;c+=1)a+=b.tmplIndentTab;
return a},e=x(f),a="",d=b.autoLineBreak.replace(/\s/gi,"").split("|"),i=!0,j=function(a){for(var b=0;b<d.length;b+=1)if(a!==null&&typeof a!=="undefined"&&(h[d[b]]===a.type.toString()||h[d[b]]===a.subtype.toString()))return!0;return!1};e.moveNext();){var l=e.current(),n=e.next();l.subtype.toString()===p&&(g-=g>0?1:0);var o=RegExp(b.newLine+"$",""),n=j(n),i=i?c():b.tmplIndentSpace;a+=M(l,b,i,n?b.newLine:"",b.customTokenRender);l.subtype.toString()===q&&(g+=1);i=n||o.test(a)}return b.trim?m(a):a};o.formatFormulaHTML=
function(f){return E(f,{tmplFunctionStart:'{{autoindent}}<span class="function">{{token}}</span><br />{{autoindent}}<span class="function_start">(</span><br />',tmplFunctionStop:'<br />{{autoindent}}{{token}}<span class="function_stop">)</span>',tmplOperandError:"{{token}}",tmplOperandRange:"{{autoindent}}{{token}}",tmplOperandLogical:" {{token}}{{autolinebreak}}",tmplOperandNumber:"{{autoindent}}{{token}}",tmplOperandText:'{{autoindent}}<span class="quote_mark">"</span><span class="text">{{token}}</span><span class="quote_mark">"</span>',
tmplArgument:"{{token}}<br />",tmplFunctionStartArray:"",tmplFunctionStartArrayRow:"{",tmplFunctionStopArrayRow:"}",tmplFunctionStopArray:"",tmplSubexpressionStart:"{{autoindent}}(",tmplSubexpressionStop:" )",tmplIndentTab:'<span class="tabs">&nbsp;&nbsp;&nbsp;&nbsp;</span>',tmplIndentSpace:"&nbsp;",newLine:"<br />",autoLineBreak:"TOK_TYPE_FUNCTION | TOK_TYPE_ARGUMENT | TOK_SUBTYPE_LOGICAL | TOK_TYPE_OP_IN ",trim:!0,customTokenRender:null})};var N=o.formula2CSharp=function(f){var b=[];return E(f,
{tmplFunctionStart:"{{token}}(",tmplFunctionStop:"{{token}})",tmplOperandError:"{{token}}",tmplOperandRange:"{{token}}",tmplOperandLogical:"{{token}}",tmplOperandNumber:"{{token}}",tmplOperandText:'"{{token}}"',tmplArgument:"{{token}}",tmplFunctionStartArray:"",tmplFunctionStartArrayRow:"{",tmplFunctionStopArrayRow:"}",tmplFunctionStopArray:"",tmplSubexpressionStart:"(",tmplSubexpressionStop:")",tmplIndentTab:"\t",tmplIndentSpace:" ",autoLineBreak:"TOK_SUBTYPE_STOP | TOK_SUBTYPE_START | TOK_TYPE_ARGUMENT",
trim:!0,customTokenRender:function(c,g){var e="",a={"=":"==","<>":"!=",MIN:"Math.Min",MAX:"Math.Max",ABS:"Math.ABS",SUM:"",IF:"","&":"+"},d=b[b.length-1],f=!1;switch(g.type.toString()){case l:switch(g.subtype){case q:b.push({name:c,argumentNumber:0});e=typeof a[c]==="string"?a[c]:c;f=!0;break;case p:f=!0;switch(d.name.toLowerCase()){case "if":e=")";f=!1;break;default:e=typeof a[c]==="string"?a[c]:c}b.pop()}break;case t:switch(d.name.toLowerCase()){case "if":switch(d.argumentNumber){case 0:e="?";break;
case 1:e=":"}break;case "sum":e="+";break;default:e=typeof a[c]==="string"?a[c]:c,f=!0}d.argumentNumber+=1;break;default:e=typeof a[c]==="string"?a[c]:c,f=!0}return{tokenString:e,useTemplate:f}}})};o.formula2JavaScript=function(f){return N(f)}})();
